# CONSTRAINTS.md — Hard Rules for AI Agents

> **This file contains IMMUTABLE constraints.** AI agents must follow these rules exactly.
> Last updated: 2026-02-23

---

## How to Use This File

Before modifying any file listed here, READ the constraint. If the change violates the constraint, STOP and discuss with Wolf.

---

## Revenue-Critical: stripe-webhook.js

- **NEVER rename or move** `functions/api/stripe-webhook.js` — Stripe webhook URL is hardcoded in Stripe Dashboard
- **NEVER change** the `onRequestPost` export signature — Cloudflare Pages requires this exact name
- **NEVER remove** the `verifyWebhookSignature()` function — Stripe signature verification prevents replay attacks
- **NEVER add async parallelism** to the Pictorem order flow — idempotency depends on sequential execution
- **NEVER modify** `MATERIAL_MAP` without testing against Pictorem's live preordercode validator
- **NEVER remove** the R2 original hard block — sending web-optimized images to Pictorem produces unacceptable print quality
- **Why:** This file processes real customer payments. Breaking it = lost orders + lost revenue.
- **Read first:** LESSONS_LEARNED.md (Lessons 017, 018, 028)

## Revenue-Critical: cart.js + cart-ui.js

- **NEVER change** the `localStorage` key `archive35_cart` — customers have active carts in their browsers
- **NEVER modify** the `metadata` object structure passed to Stripe Checkout — the webhook depends on exact field names
- **NEVER remove** the metadata validation warnings — they catch fulfillment data loss before checkout
- **Why:** Cart → Checkout → Webhook is the revenue pipeline. Metadata mismatch = order without fulfillment.

## Auth-Critical: send-magic-link.js + verify.js

- **NEVER change** the KV key format `rate:{email}` — active rate limits exist in production
- **NEVER modify** session token TTL (30 days) without discussing with Wolf (KV storage cost)
- **NEVER change** the cookie name `a35_session` — all active sessions use this name
- **NEVER remove** `context.waitUntil()` for background tasks — without it, Cloudflare kills welcome emails mid-flight
- **Why:** Breaking auth = customers can't log in. Breaking welcome emails = Wolf doesn't know about new signups.
- **Read first:** LESSONS_LEARNED.md (Lesson 030 — Cloudflare Workers async patterns)

## Gallery-Critical: gallery.html

- **NEVER touch** idle-throttling logic in CoverFlow animations without profiling on mobile
- **NEVER remove** event listener cleanup — memory leaks kill mobile browsers after 50+ swipes
- **NEVER modify** the `data-*` attributes on photo elements — they're read by cart.js for checkout metadata
- **Why:** Gallery is the primary customer-facing page. Mobile users from Instagram are the #1 traffic source.
- **Read first:** LESSONS_LEARNED.md (Lesson 011)

## Data-Critical: photography/ folder

- **NEVER delete** any file in `photography/` — only Wolf deletes
- **NEVER rename** gallery subfolders — the names are collection slugs used in URLs, R2 keys, and Stripe metadata
- **Images can only be copied out**, never moved
- **Why:** photography/ is the single source of truth for all published images

## Data-Critical: data/photos.json

- **This is a GENERATED file** — never hand-edit it
- **Generated by:** Studio deploy pipeline (sync_gallery_data.py)
- **Read by:** Mockup Service matcher.js, gallery.html, search.html
- **After regeneration:** Call `POST /match/refresh` on Mockup Service to invalidate cache
- **Why:** Hand edits get overwritten on next deploy. Stale cache = wrong mockup matches.
- **Read first:** LESSONS_LEARNED.md (Lesson 026)

## Data-Critical: templates/templates.json

- **Template IDs must match filenames** (without extension) in `templates/rooms/`
- **Use kebab-case only** for IDs and filenames (no spaces, no trailing spaces)
- **After any template change:** Invalidate Mockup Service cache (`POST /match/refresh`)
- **Why:** Filename/ID mismatch causes 404 errors on template lookups

## Process-Critical: Shared Zone (main.js, preload.js, App.js, Sidebar.js)

- **New IPC handlers ONLY** — never rename or change the signature of existing handlers
- **Changes require testing BOTH Studio AND Agent** — all 12 Studio tabs + all 7 Agent tabs + all 4 Mockup tabs
- **Additive changes only** when possible
- **If ANYTHING breaks:** Revert immediately
- **Why:** Studio, Agent, and Mockup all depend on these files. Signature change breaks all three.
- **Read first:** Architecture Integration Blueprint (08_Docs/)

## API-Critical: Agent (port 8035) and Mockup (port 8036)

- **Ports are hardcoded** in main.js, preload.js, and React pages — never change without updating all references
- **Agent uses SQLite with WAL mode** — never switch to another journal mode (breaks concurrent reads)
- **Rate limits exist for a reason** — never bypass `check_limit()` calls in Agent code
- **Kill switches are safety-critical** — never bypass `is_active()` checks
- **Why:** Port conflicts break service discovery. Rate limit bypass = runaway API costs.

## Email-Critical: All Resend integrations

- **`orders@archive-35.com`** for customer-facing transactional emails
- **`wolf@archive-35.com`** for personal emails from Wolf (welcome emails)
- **All customer emails BCC to wolf@archive-35.com** — never remove BCC
- **wolfbroadcast@gmail.com** is PERSONAL — never use for Archive-35 business
- **Why:** BCC is how Wolf tracks all customer communication. Wrong sender domain = Resend rejection.
