<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>License Photography | ARCHIVE-35</title>
<meta name="description" content="License ultra-high-resolution fine art photography. 20,000+ pixel originals. Billboard-ready. From 55+ countries.">
<meta property="og:type" content="website">
<meta property="og:site_name" content="ARCHIVE-35">
<meta property="og:title" content="License Photography | ARCHIVE-35">
<meta property="og:description" content="License ultra-high-resolution fine art photography. Billboard-ready originals from 55+ countries.">
<meta property="og:url" content="https://archive-35.com/licensing.html">
<meta property="og:image" content="https://archive-35.com/logos/archive35-og-image.png">
<meta name="robots" content="noai, noimageai">
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<link rel="apple-touch-icon" href="logos/archive35-favicon-180.png">
<link rel="icon" type="image/png" sizes="32x32" href="logos/archive35-favicon-32.png">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-SE2WETEK5D"></script>
<script>
  window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
  gtag('js',new Date());gtag('config','G-SE2WETEK5D',{anonymize_ip:true,allow_google_signals:false,allow_ad_personalization_signals:false});
</script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0D0D0D;--surface:#141414;--raised:#1C1C1C;--border:#252525;
  --text:#E8E0D0;--text-dim:#888;--text-muted:#555;
  --gold:#C9A84C;--gold-dim:#7A6830;--accent:#E94560;
  --ultra:#C9A84C;--premium:#B0B0B0;--standard:#CD7F32;
  /* cart compat */
  --text-primary:#E8E0D0;--text-secondary:#888;--text-muted:#555;
  --bg-primary:#0D0D0D;--bg-secondary:#141414;
  --glass-bg:rgba(255,255,255,0.03);--glass-bg-hover:rgba(255,255,255,0.06);
  --glass-border:rgba(255,255,255,0.08);--glass-border-hover:rgba(212,165,116,0.4);
  --glass-blur:12px;--transition:0.3s cubic-bezier(0.4,0,0.2,1);--radius-sm:8px;
  --accent:#C9A84C;--accent-hover:#f5c963;
}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:'Inter',system-ui,sans-serif;line-height:1.6;-webkit-font-smoothing:antialiased}
a{color:var(--gold);text-decoration:none;transition:color 0.2s}a:hover{color:var(--text)}
.mono{font-family:'JetBrains Mono',monospace}

/* ── NAV (shared glass pill style) ── */
.header{position:fixed;top:1.5rem;left:50%;transform:translateX(-50%);z-index:100;width:calc(100% - 3rem);max-width:1200px}
.header-inner{display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:rgba(10,10,10,0.8);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.08);border-radius:100px}
.logo-a{font-size:1rem;font-weight:300;letter-spacing:0.25em;text-transform:uppercase;color:var(--text);text-decoration:none;transition:all 0.3s}
.logo-a .gold{color:var(--gold)}
.logo-a:hover .gold{text-shadow:0 0 25px rgba(201,168,76,0.5)}
.nav-links{display:flex;gap:2.5rem;font-size:0.8rem;font-weight:400;letter-spacing:0.15em;text-transform:uppercase}
.nav-links a{color:var(--text-dim);text-decoration:none;transition:all 0.3s;position:relative}
.nav-links a::after{content:'';position:absolute;bottom:-4px;left:0;width:0;height:1px;background:var(--gold);transition:width 0.3s}
.nav-links a:hover,.nav-links a.active{color:var(--text)}
.nav-links a:hover::after,.nav-links a.active::after{width:100%}
.hamburger{display:none;background:none;border:none;color:var(--gold);font-size:22px;cursor:pointer;padding:0.5rem}

/* ── HERO ── */
.hero{position:relative;height:70vh;min-height:500px;display:flex;align-items:center;justify-content:center;text-align:center;overflow:hidden;margin-top:80px}
.hero-bg{position:absolute;inset:0;background:center/cover no-repeat;filter:brightness(0.4) saturate(0.8)}
.hero-overlay{position:absolute;inset:0;background:linear-gradient(to bottom,rgba(13,13,13,0.3),rgba(13,13,13,0.9))}
.hero-content{position:relative;z-index:2;max-width:700px;padding:0 24px}
.hero h1{font-size:clamp(28px,4vw,48px);font-weight:200;letter-spacing:6px;text-transform:uppercase;margin-bottom:16px}
.hero p{font-size:clamp(14px,1.8vw,18px);color:var(--text-dim);font-weight:300;margin-bottom:8px}
.hero p.highlight{color:var(--gold);font-family:'JetBrains Mono',monospace;font-size:clamp(12px,1.4vw,14px);letter-spacing:2px}
.hero .cta{margin-top:32px}
.hero .cta a{display:inline-block;padding:14px 36px;border:1px solid var(--gold-dim);color:var(--gold);font-size:11px;letter-spacing:3px;text-transform:uppercase;transition:all 0.3s}
.hero .cta a:hover{background:var(--gold);color:var(--bg)}

/* ── FILTERS ── */
.filters{padding:24px 40px;display:flex;gap:12px;flex-wrap:wrap;align-items:center;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:90;background:var(--bg)}
.filter-btn{padding:8px 20px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-size:11px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;font-family:inherit}
.filter-btn:hover,.filter-btn.active{border-color:var(--gold-dim);color:var(--gold);background:rgba(201,168,76,0.05)}
.filter-count{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--text-muted);margin-left:auto}

/* ── GRID ── */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;padding:40px;max-width:1600px;margin:0 auto}

/* ── IMAGE CARD ── */
.card{background:var(--surface);border:1px solid var(--border);border-radius:4px;overflow:hidden;cursor:pointer;transition:transform 0.2s,border-color 0.2s}
.card:hover{transform:translateY(-2px);border-color:var(--gold-dim)}
.card-img{position:relative;aspect-ratio:3/2;overflow:hidden;background:var(--raised)}
.card-img img{width:100%;height:100%;object-fit:cover;display:block;transition:transform 0.3s}
.card:hover .card-img img{transform:scale(1.02)}
.card-badges{position:absolute;top:10px;right:10px;display:flex;gap:6px}
.badge{padding:3px 10px;border-radius:2px;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:500;letter-spacing:1px;backdrop-filter:blur(8px)}
.badge-ultra{background:rgba(201,168,76,0.2);color:var(--ultra);border:1px solid rgba(201,168,76,0.3)}
.badge-premium{background:rgba(176,176,176,0.15);color:var(--premium);border:1px solid rgba(176,176,176,0.25)}
.badge-standard{background:rgba(205,127,50,0.15);color:var(--standard);border:1px solid rgba(205,127,50,0.25)}
.badge-res{background:rgba(0,0,0,0.6);color:var(--text);border:1px solid rgba(255,255,255,0.08)}
.badge-exclusive{background:rgba(233,69,96,0.2);color:var(--accent);border:1px solid rgba(233,69,96,0.3)}
.card-info{padding:14px 16px}
.card-title{font-size:14px;font-weight:400;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card-location{font-size:11px;color:var(--text-dim);margin-bottom:10px}
.card-meta{display:flex;justify-content:space-between;align-items:center}
.card-price{font-family:'JetBrains Mono',monospace;font-size:14px;color:var(--accent);font-weight:500}
.card-licenses{font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text-muted)}

/* ── DETAIL MODAL ── */
.modal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,0.92);opacity:0;pointer-events:none;transition:opacity 0.3s;overflow-y:auto}
.modal-overlay.open{opacity:1;pointer-events:auto}
.modal{max-width:1100px;margin:40px auto;padding:0 24px;display:grid;grid-template-columns:1fr 380px;gap:32px;align-items:start}
.modal-close{position:fixed;top:20px;right:28px;background:none;border:none;color:var(--text-dim);font-size:28px;cursor:pointer;z-index:210;transition:color 0.2s}
.modal-close:hover{color:var(--gold)}
.modal-img{border-radius:4px;overflow:hidden;background:var(--raised)}
.modal-img img{width:100%;display:block}
.modal-img canvas{-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;pointer-events:auto}
.modal-details{padding:20px 0}
.modal-details h2{font-size:24px;font-weight:300;letter-spacing:3px;margin-bottom:4px}
.modal-details .loc{font-size:12px;color:var(--text-dim);margin-bottom:20px}
.specs-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:24px}
.spec{padding:10px;background:var(--surface);border:1px solid var(--border);border-radius:3px}
.spec-label{font-size:9px;text-transform:uppercase;letter-spacing:2px;color:var(--text-muted);margin-bottom:2px}
.spec-value{font-family:'JetBrains Mono',monospace;font-size:13px;color:var(--text)}
.tier-selector{margin-bottom:20px}
.tier-selector label{display:block;font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text-dim);margin-bottom:6px}
.tier-selector select{width:100%;padding:10px 14px;background:var(--surface);border:1px solid var(--border);color:var(--text);font-size:13px;font-family:inherit;border-radius:3px;cursor:pointer}
.tier-selector select:focus{outline:none;border-color:var(--gold-dim)}
.modal-price{font-family:'JetBrains Mono',monospace;font-size:32px;color:var(--accent);font-weight:500;margin:16px 0}
.license-info{font-size:11px;color:var(--text-muted);margin-bottom:16px;line-height:1.8}
.license-count{font-family:'JetBrains Mono',monospace;color:var(--text-dim)}
.btn-license{display:block;width:100%;padding:16px;background:var(--accent);border:none;color:#fff;font-size:12px;letter-spacing:3px;text-transform:uppercase;font-family:inherit;font-weight:500;cursor:pointer;transition:all 0.2s;border-radius:3px}
.btn-license:hover{background:#d43d56;transform:translateY(-1px)}
.btn-license:disabled{opacity:0.4;cursor:not-allowed;transform:none}
.terms-check{display:flex;align-items:flex-start;gap:8px;margin:12px 0;font-size:11px;color:var(--text-dim)}
.terms-check input{margin-top:3px;accent-color:var(--gold)}
.format-row{display:flex;gap:12px;margin-bottom:16px}
.format-opt{flex:1;padding:10px;border:1px solid var(--border);text-align:center;cursor:pointer;font-size:11px;letter-spacing:1px;transition:all 0.2s}
.format-opt.selected{border-color:var(--gold-dim);color:var(--gold);background:rgba(201,168,76,0.05)}

/* ── EMPTY STATE ── */
.empty{text-align:center;padding:120px 40px;color:var(--text-muted)}
.empty h2{font-size:20px;font-weight:300;letter-spacing:4px;margin-bottom:12px;color:var(--text-dim)}
.empty p{font-size:13px;max-width:500px;margin:0 auto}

/* ── FOOTER ── */
.footer{padding:60px 40px 40px;text-align:center;border-top:1px solid var(--border);margin-top:80px}
.footer p{font-size:10px;color:var(--text-muted);letter-spacing:2px}
.footer a{color:var(--gold-dim)}

/* ── MOBILE ── */
@media(max-width:768px){
  .header{top:0.75rem;width:calc(100% - 1.5rem)}
  .header-inner{padding:0.75rem 1.25rem}
  .nav-links{display:none;position:absolute;top:60px;right:0;left:0;flex-direction:column;gap:16px;background:rgba(13,13,13,0.97);padding:20px 28px;border:1px solid var(--border);border-radius:12px;backdrop-filter:blur(12px)}
  .nav-links.open{display:flex}
  .hamburger{display:block}
  .hero{height:50vh;min-height:360px}
  .filters{padding:16px;top:0;gap:8px}
  .filter-btn{padding:6px 14px;font-size:10px}
  .grid{grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;padding:20px 16px}
  .modal{grid-template-columns:1fr;margin:20px auto;padding:0 16px}
  .modal-details{padding:0 0 40px}
}
</style>
</head>
<body>

<!-- Navigation -->
<header class="header">
  <div class="header-inner">
    <a href="index.html" class="logo-a">ARCHIVE<span class="gold">-35</span></a>
    <div class="nav-links nav" id="nav-links">
      <a href="index.html">Home</a>
      <a href="gallery.html">Gallery</a>
      <a href="licensing.html" class="active">Licensing</a>
      <a href="about.html">About</a>
      <a href="contact.html">Contact</a>
      <a href="search.html">Search</a>
    </div>
    <button class="hamburger" id="hamburger" onclick="document.getElementById('nav-links').classList.toggle('open')">&#9776;</button>
  </div>
</header>

<!-- Hero -->
<section class="hero">
  <div class="hero-bg" style="background-image:url('images/grand-teton/WOLF7301-full.jpg')"></div>
  <div class="hero-overlay"></div>
  <div class="hero-content">
    <h1>License Ultra-High-Resolution Photography</h1>
    <p class="highlight">20,000+ pixel originals &middot; Billboard-ready &middot; 55+ countries</p>
    <p>From the Serengeti to the Grand Tetons. Original files up to 200+ megapixels. Every license includes full provenance and a signed certificate.</p>
    <div class="cta"><a href="#gallery">Browse Collection</a></div>
  </div>
</section>

<!-- Filters -->
<div class="filters" id="gallery">
  <button class="filter-btn active" data-filter="all">All</button>
  <button class="filter-btn" data-filter="ULTRA">Ultra</button>
  <button class="filter-btn" data-filter="PREMIUM">Premium</button>
  <button class="filter-btn" data-filter="STANDARD">Standard</button>
  <span class="filter-count" id="filter-count"></span>
</div>

<!-- Gallery Grid -->
<div class="grid" id="grid"></div>

<!-- Empty state (shown when no images in catalog) -->
<div class="empty" id="empty" style="display:none">
  <h2>Collection Coming Soon</h2>
  <p>Ultra-high-resolution images are being prepared for the licensing catalog. Drop images into <code>09_Licensing/originals/</code> and run the pipeline to populate this gallery.</p>
</div>

<!-- Detail Modal -->
<div class="modal-overlay" id="modal">
  <button class="modal-close" onclick="closeModal()">&times;</button>
  <div class="modal">
    <div class="modal-img"><canvas id="m-canvas" style="width:100%;display:block;border-radius:4px"></canvas></div>
    <div class="modal-details">
      <h2 id="m-title"></h2>
      <div class="loc" id="m-location"></div>
      <div style="display:flex;gap:8px;margin-bottom:16px">
        <span class="badge" id="m-class-badge"></span>
        <span class="badge badge-res" id="m-res-badge"></span>
      </div>
      <div class="specs-grid">
        <div class="spec"><div class="spec-label">Resolution</div><div class="spec-value" id="m-res"></div></div>
        <div class="spec"><div class="spec-label">Megapixels</div><div class="spec-value" id="m-mp"></div></div>
        <div class="spec"><div class="spec-label">File Size</div><div class="spec-value" id="m-size"></div></div>
        <div class="spec"><div class="spec-label">Max Print 300DPI</div><div class="spec-value" id="m-print300"></div></div>
        <div class="spec"><div class="spec-label">Max Print 150DPI</div><div class="spec-value" id="m-print150"></div></div>
        <div class="spec"><div class="spec-label">Licenses Issued</div><div class="spec-value license-count" id="m-lic-count"></div></div>
      </div>
      <div class="tier-selector">
        <label>License Tier</label>
        <select id="m-tier" onchange="updatePrice()">
          <option value="web_social">Web / Social — 1 year, 5 users</option>
          <option value="editorial">Editorial — 1 year, 5 users</option>
          <option value="commercial_print">Commercial Print — 2 years, 10 users</option>
          <option value="billboard_ooh">Billboard / OOH — 1 year, 10 users</option>
          <option value="hospitality">Hospitality — Perpetual, Unlimited</option>
          <option value="exclusive">Exclusive — All uses, Negotiated term</option>
        </select>
      </div>
      <div class="format-row">
        <div class="format-opt selected" id="fmt-jpg" onclick="selectFormat('jpg')">JPEG <span style="display:block;font-size:9px;color:var(--text-muted)">Included</span></div>
        <div class="format-opt" id="fmt-tiff" onclick="selectFormat('tiff')">TIFF <span style="display:block;font-size:9px;color:var(--text-muted)">+$100</span></div>
      </div>
      <div class="modal-price" id="m-price"></div>
      <div class="license-info" id="m-lic-info"></div>
      <div class="terms-check">
        <input type="checkbox" id="m-agree" onchange="checkTerms()">
        <label for="m-agree">I have read and agree to the <a href="licensing/terms.html" target="_blank">Image License Agreement</a></label>
      </div>
      <button class="btn-license" id="m-buy" disabled onclick="handlePurchase()">License This Image</button>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="footer">
  <p>&copy; 2026 ARCHIVE-35 / The Restless Eye &middot; Wolfgang Schram &middot; <a href="licensing/terms.html">License Terms</a> &middot; <a href="contact.html">Contact</a></p>
</footer>

<script>
// ═══════════════════════════════════
// LICENSING GALLERY
// ═══════════════════════════════════
let catalog = { images: [] };
let currentImage = null;
let currentFormat = 'jpg';
let activeFilter = 'all';

async function loadCatalog() {
  try {
    const resp = await fetch('data/licensing-catalog.json');
    if (!resp.ok) throw new Error('Catalog not found');
    catalog = await resp.json();
  } catch (e) {
    catalog = { images: [] };
  }
  renderGrid();
}

function cleanTitle(title) {
  if (!title) return '';
  // Strip file extension
  let clean = title.replace(/\.(jpg|jpeg|png|tiff?)$/i, '');
  // Replace underscores and hyphens with spaces
  clean = clean.replace(/[-_]/g, ' ');
  // Remove common suffixes
  clean = clean.replace(/\b(Pano|Edit|HDR|Stitch)\b/gi, '').trim();
  // Collapse multiple spaces
  clean = clean.replace(/\s+/g, ' ').trim();
  // If it's just a camera code like "WOLF3219" or "IMG 0140", make it prettier
  if (/^(WOLF|IMG|DSC|DJI)\s*\d+$/i.test(clean)) {
    return 'Panoramic ' + clean;
  }
  return clean || title;
}

function renderGrid() {
  const grid = document.getElementById('grid');
  const empty = document.getElementById('empty');
  const filtered = catalog.images.filter(img =>
    activeFilter === 'all' || img.classification === activeFilter
  ).filter(img => img.status !== 'draft');

  document.getElementById('filter-count').textContent = filtered.length + ' image' + (filtered.length !== 1 ? 's' : '');

  if (filtered.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';

  grid.innerHTML = filtered.map(img => {
    const cls = img.classification.toLowerCase();
    const badgeClass = 'badge-' + cls;
    const isExclusive = img.status === 'exclusively_licensed';

    return `
      <div class="card" onclick="openModal('${img.id}')">
        <div class="card-img">
          <img src="${img.thumbnail}" alt="${cleanTitle(img.title)}" loading="lazy">
          <div class="card-badges">
            <span class="badge ${badgeClass}">${img.classification}</span>
            <span class="badge badge-res mono">${img.width.toLocaleString()} × ${img.height.toLocaleString()}</span>
            ${isExclusive ? '<span class="badge badge-exclusive">EXCLUSIVELY LICENSED</span>' : ''}
          </div>
        </div>
        <div class="card-info">
          <div class="card-title">${cleanTitle(img.title) || img.id}</div>
          <div class="card-location">${img.location || ''}</div>
          <div class="card-meta">
            <span class="card-price">From $${img.starting_price.toLocaleString()}</span>
            <span class="card-licenses">${img.license_count} license${img.license_count !== 1 ? 's' : ''} issued</span>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

function openModal(id) {
  const img = catalog.images.find(i => i.id === id);
  if (!img) return;
  currentImage = img;
  currentFormat = 'jpg';

  // Load preview via fetch + blob URL → draw on canvas (no direct image URL to steal)
  loadProtectedPreview(img.preview);
  document.getElementById('m-title').textContent = img.title || img.id;
  document.getElementById('m-location').textContent = img.location || '';

  // Classification badge
  const cb = document.getElementById('m-class-badge');
  cb.textContent = img.classification;
  cb.className = 'badge badge-' + img.classification.toLowerCase();

  document.getElementById('m-res-badge').textContent = img.width.toLocaleString() + ' × ' + img.height.toLocaleString();
  document.getElementById('m-res').textContent = img.width.toLocaleString() + ' × ' + img.height.toLocaleString() + ' px';
  document.getElementById('m-mp').textContent = img.megapixels + ' MP';
  document.getElementById('m-size').textContent = img.file_size_mb + ' MB';

  const p300 = img.max_print_300dpi || {};
  const p150 = img.max_print_150dpi || {};
  document.getElementById('m-print300').textContent = p300.width_in ? p300.width_in + '" × ' + p300.height_in + '"' : '—';
  document.getElementById('m-print150').textContent = p150.width_in ? p150.width_in + '" × ' + p150.height_in + '"' : '—';

  document.getElementById('m-lic-count').textContent =
    img.license_count === 0 ? 'None — be the first!' : img.license_count + ' issued';

  // Reset
  document.getElementById('m-tier').value = 'web_social';
  document.getElementById('m-agree').checked = false;
  document.getElementById('m-buy').disabled = true;
  document.getElementById('fmt-jpg').classList.add('selected');
  document.getElementById('fmt-tiff').classList.remove('selected');

  updatePrice();
  document.getElementById('modal').classList.add('open');
  document.body.style.overflow = 'hidden';
}

// ── Protected preview: fetch → blob → canvas (no direct URL to steal) ──
let currentBlobUrl = null;
function loadProtectedPreview(previewPath) {
  const canvas = document.getElementById('m-canvas');
  const ctx = canvas.getContext('2d');

  // Clear previous
  if (currentBlobUrl) { URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; }
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  fetch(previewPath)
    .then(r => r.blob())
    .then(blob => {
      currentBlobUrl = URL.createObjectURL(blob);
      const tempImg = new window.Image();
      tempImg.onload = () => {
        canvas.width = tempImg.naturalWidth;
        canvas.height = tempImg.naturalHeight;
        ctx.drawImage(tempImg, 0, 0);
        URL.revokeObjectURL(currentBlobUrl);
        currentBlobUrl = null;
      };
      tempImg.src = currentBlobUrl;
    })
    .catch(() => {
      // Fallback: if fetch fails, just show text
      canvas.width = 800; canvas.height = 400;
      ctx.fillStyle = '#1C1C1C'; ctx.fillRect(0, 0, 800, 400);
      ctx.fillStyle = '#555'; ctx.font = '16px Inter, sans-serif';
      ctx.textAlign = 'center'; ctx.fillText('Preview unavailable', 400, 200);
    });
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
  document.body.style.overflow = '';
  // Clean up blob URL
  if (currentBlobUrl) { URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; }
  // Clear canvas
  const canvas = document.getElementById('m-canvas');
  if (canvas) { const ctx = canvas.getContext('2d'); ctx.clearRect(0, 0, canvas.width, canvas.height); }
  currentImage = null;
}

function selectFormat(fmt) {
  currentFormat = fmt;
  document.getElementById('fmt-jpg').classList.toggle('selected', fmt === 'jpg');
  document.getElementById('fmt-tiff').classList.toggle('selected', fmt === 'tiff');
  updatePrice();
}

function updatePrice() {
  if (!currentImage) return;
  const tier = document.getElementById('m-tier').value;
  let price = currentImage.pricing[tier] || 0;
  if (currentFormat === 'tiff') price += 100;

  document.getElementById('m-price').textContent = '$' + price.toLocaleString();

  // License info
  const tierInfo = catalog.tiers ? catalog.tiers[tier] : {};
  let info = `Duration: ${tierInfo.duration || '—'} · Geography: ${tierInfo.geography || '—'} · Max Users: ${tierInfo.max_users || '—'}`;
  if (tier === 'exclusive') {
    info += `<br>Image will be removed from marketplace within 48 hours. Prior licenses remain valid.`;
  }
  document.getElementById('m-lic-info').innerHTML = info;

  const isExclusive = currentImage.status === 'exclusively_licensed';
  const btn = document.getElementById('m-buy');
  if (isExclusive) {
    btn.textContent = 'EXCLUSIVELY LICENSED';
    btn.disabled = true;
  } else {
    btn.textContent = 'License This Image';
    checkTerms();
  }
}

function checkTerms() {
  const agreed = document.getElementById('m-agree').checked;
  const isExclusive = currentImage && currentImage.status === 'exclusively_licensed';
  document.getElementById('m-buy').disabled = !agreed || isExclusive;
}

async function handlePurchase() {
  if (!currentImage) return;
  const tier = document.getElementById('m-tier').value;
  const tierInfo = catalog.tiers ? catalog.tiers[tier] : {};
  const tierName = tierInfo.name || tier;
  let price = currentImage.pricing[tier] || 0;
  if (currentFormat === 'tiff') price += 100;
  const priceInCents = price * 100;

  const btn = document.getElementById('m-buy');
  btn.textContent = 'Processing...';
  btn.disabled = true;

  const isTestMode = window.STRIPE_PUBLIC_KEY && window.STRIPE_PUBLIC_KEY.startsWith('pk_test_');

  const checkoutData = {
    lineItems: [{
      price_data: {
        currency: 'usd',
        product_data: {
          name: (currentImage.title || currentImage.id) + ' — ' + tierName + ' License',
          description: currentFormat.toUpperCase() + ' · ' + currentImage.width + ' × ' + currentImage.height + ' px',
        },
        unit_amount: priceInCents
      },
      quantity: 1
    }],
    successUrl: window.location.origin + '/thank-you.html?session_id={CHECKOUT_SESSION_ID}',
    cancelUrl: window.location.href,
    license: {
      photoId: currentImage.id,
      photoTitle: currentImage.title || currentImage.id,
      photoFilename: currentImage.filename || currentImage.id,
      collection: currentImage.collection || 'licensing',
      tier: tier,
      tierName: tierName,
      format: currentFormat,
      classification: currentImage.classification || '',
      resolution: currentImage.width + 'x' + currentImage.height
    },
    testMode: isTestMode || false
  };

  try {
    const apiBase = 'https://archive-35-com.pages.dev';
    const resp = await fetch(apiBase + '/api/create-checkout-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(checkoutData)
    });
    const data = await resp.json();
    if (data.error) {
      alert('Checkout error: ' + data.error);
      btn.textContent = 'License This Image';
      btn.disabled = false;
      return;
    }
    if (data.url) {
      if (isTestMode) console.log('[ARCHIVE-35] Checkout session created in TEST mode');
      window.location.href = data.url;
    } else {
      alert('Failed to create checkout session. Please try again.');
      btn.textContent = 'License This Image';
      btn.disabled = false;
    }
  } catch (err) {
    console.error('Checkout error:', err);
    alert('Connection error. Please try again.');
    btn.textContent = 'License This Image';
    btn.disabled = false;
  }
}

// Filter buttons
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    activeFilter = btn.dataset.filter;
    renderGrid();
  });
});

// Close modal on overlay click or Escape
document.getElementById('modal').addEventListener('click', e => {
  if (e.target.id === 'modal') closeModal();
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') closeModal();
});

// Retry failed images with stagger to avoid rate limiting
function retryFailedImages() {
  const imgs = document.querySelectorAll('.card-img img');
  let delay = 0;
  imgs.forEach(img => {
    if (img.complete && img.naturalWidth === 0) {
      delay += 150;
      setTimeout(() => {
        const src = img.src;
        img.src = '';
        img.src = src + (src.includes('?') ? '&' : '?') + 'r=' + Date.now();
      }, delay);
    }
  });
  // Check again after all retries
  if (delay > 0) {
    setTimeout(retryFailedImages, delay + 2000);
  }
}
// Start retry after initial load attempt
setTimeout(retryFailedImages, 2000);

// Block right-click and drag on canvas (copy protection)
document.addEventListener('contextmenu', e => {
  if (e.target.tagName === 'CANVAS') { e.preventDefault(); return false; }
});
document.addEventListener('dragstart', e => {
  if (e.target.tagName === 'CANVAS') { e.preventDefault(); return false; }
});

// Init
loadCatalog();
</script>
<link rel="stylesheet" href="css/cart.css">
<script src="https://js.stripe.com/v3/"></script>
<script>window.STRIPE_PUBLIC_KEY = 'pk_test_51SxIaWIyLqYsy9lvQBUlhX2aj0atlTuHbA1Q0861MUuaUPAaxjtrwh71GqBUMhYcdzyDgCBZQ2TLS2nTaAVNZrgP00OHqZD4OI';</script>
<script src="js/cart.js"></script>
<script src="js/cart-ui.js?v=2"></script>
<script src="js/image-protection.js"></script>
</body>
</html>
